# ZSwagger

[![Go Reference](https://pkg.go.dev/badge/github.com/go-zing/gozz-kit/zapi/zswagger.svg)](https://pkg.go.dev/github.com/go-zing/gozz-kit/zapi/zswagger)

ä» Go æ¥å£å’Œç»“æ„ä½“ç”Ÿæˆ [Swagger 2.0](https://swagger.io/specification/v2/) OpenAPI æ–‡æ¡£ã€‚

ZSwagger æ˜¯ [gozz-kit](https://github.com/go-zing/gozz-kit) ç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä¸ gozz ä»£ç ç”Ÿæˆå·¥å…·æ— ç¼åä½œï¼Œè‡ªåŠ¨åˆ›å»ºå…¨é¢çš„ API æ–‡æ¡£ã€‚

## ç‰¹æ€§

- ğŸš€ **è‡ªåŠ¨ç”Ÿæˆ**ï¼šè§£æ Go æ¥å£å’Œç»“æ„ä½“ä»¥ç”Ÿæˆ OpenAPI è§„èŒƒ
- ğŸ”„ **é€’å½’ç±»å‹æ”¯æŒ**ï¼šå®‰å…¨å¤„ç†å¤æ‚çš„åµŒå¥—å’Œé€’å½’æ•°æ®ç»“æ„
- ğŸ“ **æ–‡æ¡£æå–**ï¼šä» Go æ³¨é‡Šä¸­æå–æ–‡æ¡£
- ğŸ¯ **çµæ´»çš„å‚æ•°ç»‘å®š**ï¼šå¯é…ç½®çš„ç»“æ„ä½“å­—æ®µåˆ°è·¯å¾„ã€æŸ¥è¯¢ã€å¤´éƒ¨å’Œä¸»ä½“å‚æ•°çš„æ˜ å°„
- ğŸ—ï¸ **ç±»å‹å®‰å…¨**ï¼šå®Œå…¨ç±»å‹æ„ŸçŸ¥çš„æ¨¡å¼ç”Ÿæˆï¼Œå…·æœ‰é€‚å½“çš„éªŒè¯
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šè®°å¿†åŒ–è§£æé˜²æ­¢å†—ä½™å·¥ä½œï¼Œç¡®ä¿å¿«é€Ÿç”Ÿæˆ

## å®‰è£…

```bash
go get github.com/go-zing/gozz-kit/zapi/zswagger
```

## å¿«é€Ÿå¼€å§‹

### 1. å®šä¹‰æ‚¨çš„ API æ¥å£

```go
package api

import "context"

//go:generate gozz run -p "doc" -p "api" ./

// +zz:api:./
// ç”¨æˆ·ç®¡ç† API
type UserService interface {
    // +zz:api:get|/users
    // è·å–æ‰€æœ‰ç”¨æˆ·
    ListUsers(ctx context.Context) ([]User, error)

    // +zz:api:get|/users/{id}
    // æ ¹æ® ID è·å–ç”¨æˆ·
    GetUser(ctx context.Context, id int64) (User, error)

    // +zz:api:post|/users
    // åˆ›å»ºæ–°ç”¨æˆ·
    CreateUser(ctx context.Context, req CreateUserRequest) (User, error)
}

type User struct {
    ID       int64  `json:"id"`
    Name     string `json:"name"`
    Email    string `json:"email"`
    CreatedAt time.Time `json:"created_at"`
}

type CreateUserRequest struct {
    Name  string `json:"name" validate:"required"`
    Email string `json:"email" validate:"required,email"`
}
```

### 2. ç”Ÿæˆæ–‡æ¡£

```go
package main

import (
    "encoding/json"
    "os"

    "github.com/go-zing/gozz-kit/zapi/zswagger"
    "github.com/go-zing/gozz-kit/zdoc"
)

func main() {
    swagger := zswagger.Parse(
        api.UserService{},
        zswagger.WithDocFunc(zdoc.TypesDoc(api.ZZ_types_doc).TypeFieldDoc),
    )

    // å†™å…¥æ–‡ä»¶
    data, _ := json.MarshalIndent(swagger, "", "  ")
    os.WriteFile("swagger.json", data, 0644)
}
```

## é…ç½®é€‰é¡¹

### å‚æ•°ç»‘å®š

æ§åˆ¶ç»“æ„ä½“å­—æ®µå¦‚ä½•æ˜ å°„åˆ° OpenAPI å‚æ•°ï¼š

```go
swagger := zswagger.Parse(
    api.UserService{},
    zswagger.WithBindings(map[string]zswagger.Binding{
        "GET": {
            Path:   "uri",    // å¸¦æœ‰ "uri" æ ‡ç­¾çš„å­—æ®µè¿›å…¥è·¯å¾„å‚æ•°
            Query:  "form",   // å¸¦æœ‰ "form" æ ‡ç­¾çš„å­—æ®µè¿›å…¥æŸ¥è¯¢å‚æ•°
            Header: "",       // æ— å¤´éƒ¨å‚æ•°
            Body:   false,    // ä¸ä½¿ç”¨è¯·æ±‚ä¸»ä½“
        },
        "POST": {
            Path:   "uri",
            Query:  "",
            Header: "",
            Body:   true,     // ä½¿ç”¨æ•´ä¸ªç»“æ„ä½“ä½œä¸ºè¯·æ±‚ä¸»ä½“
        },
    }),
)
```

### è‡ªå®šä¹‰ HTTP æ˜ å°„

å¦‚æœæ‚¨çš„ API å®šä¹‰ä¸éµå¾ªé»˜è®¤çš„ `METHOD|PATH` æ ¼å¼ï¼š

```go
swagger := zswagger.Parse(
    api.UserService{},
    zswagger.WithHttpCast(func(api zapi.Api) zapi.HttpApi {
        // è‡ªå®šä¹‰é€»è¾‘å°† API è½¬æ¢ä¸º HTTP API
        parts := strings.Split(api.Resource, "|")
        return zapi.HttpApi{
            Api:    api,
            Method: parts[0],
            Path:   parts[1],
        }
    }),
)
```

### æ–‡æ¡£å‡½æ•°

è‡ªå®šä¹‰æ–‡æ¡£æå–æ–¹å¼ï¼š

```go
swagger := zswagger.Parse(
    api.UserService{},
    zswagger.WithDocFunc(func(typ reflect.Type, fieldName string) string {
        // è‡ªå®šä¹‰æ–‡æ¡£æå–é€»è¾‘
        return getCustomDoc(typ, fieldName)
    }),
)
```

## æ”¯æŒçš„ç±»å‹

ZSwagger è‡ªåŠ¨ä¸ºä»¥ä¸‹ç±»å‹ç”Ÿæˆæ¨¡å¼ï¼š

- **åŸºæœ¬ç±»å‹**ï¼š`string`ã€`int`ã€`int64`ã€`uint`ã€`float`ã€`bool`
- **æ—¶é—´ç±»å‹**ï¼š`time.Time` â†’ å¸¦æœ‰ `date-time` æ ¼å¼çš„ `string`
- **ç½‘ç»œç±»å‹**ï¼š`net.IP` â†’ å¸¦æœ‰ `ipv4` æ ¼å¼çš„ `string`ï¼Œ`url.URL` â†’ å¸¦æœ‰ `uri` æ ¼å¼çš„ `string`
- **äºŒè¿›åˆ¶æ•°æ®**ï¼š`[]byte` â†’ å¸¦æœ‰ `base64` æ ¼å¼çš„ `string`
- **JSON æ•°æ®**ï¼š`json.RawMessage` â†’ `object`
- **å¤æ‚ç±»å‹**ï¼šç»“æ„ä½“ã€æ˜ å°„ã€åˆ‡ç‰‡ã€æ•°ç»„
- **æŒ‡é’ˆ**ï¼šæ­£ç¡®å¤„ç†å¯é€‰å­—æ®µ
- **åµŒå…¥ç»“æ„ä½“**ï¼šå±•å¹³åµŒå…¥å­—æ®µ
- **é€’å½’ç±»å‹**ï¼šå®‰å…¨å¤„ç†å¾ªç¯å¼•ç”¨

## è‡ªå®šä¹‰ç±»å‹æ³¨å†Œ

ä¸ºç‰¹å®šç±»å‹æ³¨å†Œè‡ªå®šä¹‰æ¨¡å¼ç”Ÿæˆå™¨ï¼š

```go
// æ³¨å†Œè‡ªå®šä¹‰ç±»å‹
zswagger.RegisterSchemaType(reflect.TypeOf(MyCustomType{}), func(schema *spec.Schema) {
    schema.Typed("string", "custom-format")
})
```

## ç”Ÿæˆè¾“å‡º

ç”Ÿæˆçš„ Swagger è§„èŒƒåŒ…æ‹¬ï¼š

- **è·¯å¾„**ï¼šå¸¦æœ‰æ–¹æ³•ã€å‚æ•°å’Œå“åº”çš„ API ç«¯ç‚¹
- **å®šä¹‰**ï¼šæ‰€æœ‰ç±»å‹çš„æ¨¡å¼å®šä¹‰
- **æ ‡ç­¾**ï¼šç»„ç»‡çš„ API ç»„
- **ä¿¡æ¯**ï¼šåŸºæœ¬ API ä¿¡æ¯

ç”Ÿæˆçš„è§„èŒƒç¤ºä¾‹ï¼š

```json
{
  "swagger": "2.0",
  "info": {
    "title": "api.UserService",
    "version": "unknown",
    "description": "This file is generated by gozz-kit-zswagger"
  },
  "paths": {
    "/users": {
      "get": {
        "operationId": "api.UserService.ListUsers",
        "responses": {
          "200": {
            "schema": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/api.User"
              }
            }
          }
        }
      },
      "post": {
        "operationId": "api.UserService.CreateUser",
        "parameters": [
          {
            "name": "body",
            "in": "body",
            "schema": {
              "$ref": "#/definitions/api.CreateUserRequest"
            }
          }
        ],
        "responses": {
          "200": {
            "schema": {
              "$ref": "#/definitions/api.User"
            }
          }
        }
      }
    }
  },
  "definitions": {
    "api.User": {
      "type": "object",
      "properties": {
        "id": {"type": "integer", "format": "int64"},
        "name": {"type": "string"},
        "email": {"type": "string"}
      }
    }
  }
}
```

## API å‚è€ƒ

### å‡½æ•°

#### `Parse(iterator zapi.Iterator, options ...func(*Option)) *spec.Swagger`

è§£æ API è¿­ä»£å™¨å¹¶ç”Ÿæˆ Swagger è§„èŒƒã€‚

**å‚æ•°ï¼š**
- `iterator`ï¼šAPI è¿­ä»£å™¨ï¼ˆé€šå¸¸æ˜¯å®ç° zapi.Iterator çš„ç»“æ„ä½“ï¼‰
- `options`ï¼šå¯é€‰çš„é…ç½®å‡½æ•°

**è¿”å›ï¼š** `*spec.Swagger` - ç”Ÿæˆçš„ OpenAPI è§„èŒƒ

#### `RegisterSchemaType(typ reflect.Type, fn func(*spec.Schema))`

ä¸ºç‰¹å®šçš„ Go ç±»å‹æ³¨å†Œè‡ªå®šä¹‰æ¨¡å¼ç”Ÿæˆå™¨ã€‚

**å‚æ•°ï¼š**
- `typ`ï¼šè¦æ³¨å†Œçš„ reflect.Type
- `fn`ï¼šé…ç½®æ¨¡å¼çš„å‡½æ•°

### ç±»å‹

#### `Option`

è§£æçš„é…ç½®é€‰é¡¹ã€‚

```go
type Option struct {
    HttpCast func(api zapi.Api) zapi.HttpApi  // è‡ªå®šä¹‰ HTTP æ˜ å°„
    Bindings map[string]Binding               // å‚æ•°ç»‘å®šè§„åˆ™
    DocFunc  func(reflect.Type, string) string // æ–‡æ¡£æå–
}
```

#### `Binding`

HTTP æ–¹æ³•çš„å‚æ•°ç»‘å®šé…ç½®ã€‚

```go
type Binding struct {
    Path   string  // è·¯å¾„å‚æ•°çš„ç»“æ„ä½“æ ‡ç­¾ï¼ˆä¾‹å¦‚ "uri"ï¼‰
    Query  string  // æŸ¥è¯¢å‚æ•°çš„ç»“æ„ä½“æ ‡ç­¾ï¼ˆä¾‹å¦‚ "form"ï¼‰
    Header string  // å¤´éƒ¨å‚æ•°çš„ç»“æ„ä½“æ ‡ç­¾
    Body   bool    // æ˜¯å¦ä½¿ç”¨æ•´ä¸ªç»“æ„ä½“ä½œä¸ºè¯·æ±‚ä¸»ä½“
}
```

### é€‰é¡¹å‡½æ•°

#### `WithHttpCast(fn func(api zapi.Api) zapi.HttpApi) func(*Option)`

è®¾ç½®è‡ªå®šä¹‰ HTTP API æ˜ å°„å‡½æ•°ã€‚

#### `WithBindings(bindings map[string]Binding) func(*Option)`

è®¾ç½®ä¸åŒ HTTP æ–¹æ³•çš„å‚æ•°ç»‘å®šè§„åˆ™ã€‚

#### `WithDocFunc(fn func(reflect.Type, string) string) func(*Option)`

è®¾ç½®è‡ªå®šä¹‰æ–‡æ¡£æå–å‡½æ•°ã€‚

## ä¸ Gozz é›†æˆ

ZSwagger ä¸ [gozz](https://github.com/go-zing/gozz) ä»£ç ç”Ÿæˆå·¥å…·é…åˆæœ€ä½³ï¼š

1. ä½¿ç”¨ `+zz:api:` æ³¨é‡Šæ ‡æ³¨æ‚¨çš„æ¥å£
2. è¿è¡Œ `gozz run -p "api" -p "doc" ./` ç”Ÿæˆ API å…ƒæ•°æ®
3. ä½¿ç”¨ ZSwagger ç”Ÿæˆ OpenAPI æ–‡æ¡£

## ç¤ºä¾‹

æŸ¥çœ‹ [example_test.go](example_test.go) å’Œ [example.json](example.json) æ–‡ä»¶ï¼Œäº†è§£åŒ…å«å¤æ‚ç±»å‹ã€é€’å½’ç»“æ„å’Œå„ç§å‚æ•°ç»‘å®šçš„å®Œæ•´å·¥ä½œç¤ºä¾‹ã€‚

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·æŸ¥çœ‹ä¸»è¦çš„ [gozz-kit ä»“åº“](https://github.com/go-zing/gozz-kit) ä»¥è·å–è´¡çŒ®æŒ‡å—ã€‚

## è®¸å¯è¯

æ­¤é¡¹ç›®çš„è®¸å¯è¯ä¸ gozz-kit ç›¸åŒã€‚</content>
<parameter name="filePath">/Users/xp/Desktop/gozz-kit/zapi/zswagger/README_zh.md